version: "3.9"

networks:
  proxy:
    name: proxy
    driver: bridge
  internal:
    name: internal
    driver: bridge

services:
  # ===== Traefik =====
  traefik:
    image: traefik:v3.0
    env_file:
      - /srv/.env
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--api.dashboard=true"
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - proxy

  # ===== Infra API =====
  infra-api:
    build: ../infra-api
    env_file:
      - /srv/.env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /srv/data/logs/infra-api:/app/logs
    networks:
      - proxy
      - internal
    labels:
      - traefik.enable=true
      - traefik.http.routers.infra.rule=Host(`${DOMAIN}`)
      - traefik.http.routers.infra.entrypoints=web
      - traefik.http.services.infra.loadbalancer.server.port=8000

  # ===== Infra UI =====
  infra-ui:
    build: ../infra-ui
    env_file:
      - /srv/.env
    networks:
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.ui.rule=Host(`ui.${DOMAIN}`)
      - traefik.http.routers.ui.entrypoints=web
      - traefik.http.services.ui.loadbalancer.server.port=80

  # ===== OCR API =====
  ocr-api:
    build: ../ocr/ocr-api
    env_file:
      - /srv/.env
    volumes:
      - /srv/data/ocr/uploads:/app/uploads
      - /srv/data/ocr/results:/app/results
    networks:
      - proxy
      - internal
    labels:
      - traefik.enable=true
      - traefik.http.routers.ocr.rule=Host(`ocr.${DOMAIN}`)
      - traefik.http.routers.ocr.entrypoints=web
      - traefik.http.services.ocr.loadbalancer.server.port=8000
    depends_on:
      - redis

  # ===== OCR Worker =====
  ocr-worker:
    build: ../ocr/ocr-worker
    env_file:
      - /srv/.env
    volumes:
      - /srv/data/ocr/uploads:/app/uploads
      - /srv/data/ocr/results:/app/results
    networks:
      - internal
    depends_on:
      - redis
      - ocr-api
      - tesseract

  # ===== Redis =====
  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - /srv/data/redis:/data
    networks:
      - internal

  # ===== Tesseract =====
  tesseract:
    image: tesseractshadow/tesseract4re:4.1.1
    networks:
      - internal
    command: tail -f /dev/null  # contenedor utilitario OCR
